<html>
</script><head><title>Steemit Post Filtering</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
    <script src="https://unpkg.com/dsteem@^0.9.0/dist/dsteem.js"></script>
<script>
  var client = new dsteem.Client('https://gtg.steem.house:8090')

  function loadPosts(account, start, callback) {
    return getPosts(account, start, [], new Set(), callback);
  }

  function getPosts(account, start, posts, visitedPermlinks, callback) {
    let last_trans = start;
  
    console.log(`Fetching account history for ${account} at ${start}`);
    $('#loading').toggle(true);
    client.database.call('get_account_history', [account, start, (start < 0) ? 10000 : Math.min(start, 10000)]).then((result) => {
      let hasError = false;
    
      if (!hasError) {
        result.reverse();

        result.forEach(function(trans) {
          var op = trans[1].op;

          if(op[0] == 'comment') {
            const post = op[1];
            
            if (post.parent_author === '' && post.author === account && post.title) {
              if (!visitedPermlinks.has(post.permlink)) {
                visitedPermlinks.add(post.permlink);

                const jsonMetadata = JSON.parse(post.json_metadata);

                posts.push({
                  author: account,
                  timestamp: trans[1].timestamp,
                  title: post.title,
                  permlink: post.permlink,
                  tags: jsonMetadata.tags,
                });
              }
            }
          }
          // Save the ID of the last transaction that was processed.
          last_trans = trans[0];
        });

        if(last_trans > 0 && last_trans != start) {
        } else {
          if (last_trans > 0) {
            console.log('Missing account history.... last trans: ' + last_trans);
            hasError = true;
          }
        }
      }

      if (hasError) {
        // add indication that loading failed
        posts.unshift({
          author: account,
          timestamp: 'Error while loading',
          title: '',
          permlink: '',
          tags: '',
        });
      }
      callback(posts, last_trans);
    }, (err) => {
      let hasError = false;
      if (err) {
        console.log('error');
        console.log(err);
        hasError = true;
      }
      if (hasError) {
        // add indication that loading failed
        posts.unshift({
          author: account,
          timestamp: 'Error while loading',
          title: '',
          permlink: '',
          tags: '',
        });
      }
      callback(posts);
    }); 
  }

  function printPosts(posts, filterFn) {
    posts.filter(filterFn).forEach(post => {
      $('#data-table tr:last').after('<tr><td>' + post.timestamp + '</td><td>' + post.tags + '</td><td>' + '<a href="https://steemit.com/@' + post.author + '/' + post.permlink + '">' + post.title + '</a></td></tr>');
    });
  }
  
  function loadAll(account, start, filter) {
    loadPosts(account, start, (posts, last_trans) => {
      printPosts(posts, filter);
      $('#loading').toggle(false);
      if (last_trans > 0 && last_trans != start) {
        loadAll(account, last_trans, filter);
      }
    });
  }

  var urlParams = new URLSearchParams(window.location.search);
  var tags = urlParams.get('tags');
  loadAll(urlParams.get('account'), -1, elt => tags ? elt.tags && elt.tags.filter(t => tags.includes(t)).length > 0 : true);
</script>
  </head>
  <body>
  <table id="data-table">
    <tr><td>Time</td><td>Tags</td><td>Post</td></tr>
  </table>
  <div id="loading">Loading more...</div>
  </body>
</html>
